<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width" />
    <title>高德地图</title>
    <style>
      html,
      body,
      #container {
        width: 100%;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <div id="container"></div>

    <script type="text/javascript">
      window._AMapSecurityConfig = {
        securityJsCode: '「您申请的安全密钥」',
      }
    </script>
    <script src="https://webapi.amap.com/loader.js"></script>
    <script type="text/javascript">
      AMapLoader.load({
        key: '5fbfab5b6f6d13a9bff742af384c7615',
        version: '1.4.13',
      })
        .then((AMap) => {
          initMap()
        })
        .catch((e) => {
          console.error(e) //加载错误提示
        })

      async function initMap() {
        const map = new AMap.Map('container', {
          resizeEnable: true,
          scrollWheel: true,
          zoom: 14,
          center: [106.542245, 29.561682],
        })

        const data = await fetch('./amap.json').then((r) => r.json())
        const points = data.gpsDtos

        const path = points.map((point) => {
          return new AMap.LngLat(point.longitude, point.latitude)
        })

        const polyline = new AMap.Polyline({
          path: path,
          borderWeight: 2,
          strokeColor: '#2878FF',
          lineJoin: 'round',
        })

        map.add(polyline)

        // https://a.amap.com/jsapi_demos/static/demo-center/icons/dir-marker.png
        const iconStart = new AMap.Icon({
          size: new AMap.Size(40, 40), // 图标尺寸
          image: '//a.amap.com/jsapi_demos/static/demo-center/icons/dir-marker.png', // Icon的图像
          imageOffset: new AMap.Pixel(0, 0), // 图像相对展示区域的偏移量，适于雪碧图等
          imageSize: new AMap.Size(120, 40), // 根据所设置的大小拉伸或压缩图片
        })

        const markerStart = new AMap.Marker({
          position: new AMap.LngLat(points[0].longitude, points[0].latitude),
          icon: iconStart, // 添加 Icon 实例
          offset: new AMap.Pixel(-20, -20),
          zoom: 13,
        })

        map.add(markerStart)

        const iconEnd = new AMap.Icon({
          size: new AMap.Size(40, 40), // 图标尺寸
          image: '//a.amap.com/jsapi_demos/static/demo-center/icons/dir-marker.png', // Icon的图像
          imageOffset: new AMap.Pixel(-80, 0), // 图像相对展示区域的偏移量，适于雪碧图等
          imageSize: new AMap.Size(120, 40), // 根据所设置的大小拉伸或压缩图片
        })

        const markerEnd = new AMap.Marker({
          position: new AMap.LngLat(points.at(-1).longitude, points.at(-1).latitude),
          icon: iconEnd, // 添加 Icon 实例
          offset: new AMap.Pixel(-20, -20),
          zoom: 13,
        })

        map.add(markerEnd)

        const iconCar = new AMap.Icon({
          size: new AMap.Size(26, 52), // 图标尺寸
          image: 'https://a.amap.com/jsapi_demos/static/demo-center-v2/car.png',
        })

        const markerCar = new AMap.Marker({
          map: map,
          position: [points.at(0).longitude, points.at(0).latitude],
          icon: iconCar,
          offset: new AMap.Pixel(-13, -26),
          autoRotation: true,
        })

        const lineArr = points.map((i) => [i.longitude, i.latitude])

        let i = 0

        function carMove() {
          markerCar.moveTo(lineArr[i], 120000)
          i++
          setTimeout(() => {
            carMove()
          }, 16.7)
        }

        carMove()
      }
    </script>
  </body>
</html>
